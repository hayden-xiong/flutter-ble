# 更新日志

## [2025-11-20] - 重大更新

### ✅ 已完成

#### 1. BLE 分包传输功能
- **问题**: 发送多个唤醒词时数据包超过 BLE 253 字节限制
- **解决方案**: 实现完整的分包传输协议
- **协议文档**: [BLE分包传输协议规范.md](protocols/BLE分包传输协议规范.md)
- **状态**: App 端已完成 ✅，等待设备端实现

**功能特性**：
- 自动检测数据包大小
- 数据 > 240 字节时自动启用分包
- 每个分包格式：`[包序号][总包数][数据]`
- 包间延迟 50ms，避免设备处理不过来
- 完整的错误处理和重试机制

**使用示例**：
```dart
// 自动处理，无需手动调用
await _bleService.setWakeWords(
  words: [word1, word2, word3],  // 3个唤醒词会自动分包
  threshold: 0.15,
);
```

#### 2. 本地音素转换功能
- **功能**: 纯 Dart 实现的文本到音素转换
- **词汇量**: 60+ 常用词
- **性能**: < 1ms 转换时间
- **文档**: [本地音素转换快速参考.md](guides/本地音素转换快速参考.md)

**支持的唤醒词**：
- 问候: hi, hey, hello, ok, okay
- 品牌: alexa, siri, google, jarvis, cortana, bixby
- 动作: turn, open, close, start, stop, play, pause
- 方向: on, off, up, down, left, right

#### 3. UI 改进

**发送按钮状态**：
- 🔵 **默认**: "发送到设备" - 正常状态
- ⏳ **发送中**: "发送中..." + 加载动画
- ✅ **成功**: "已发送 ✓" + 绿色背景（3秒后自动恢复）

**用户体验优化**：
- 选择 > 2 个唤醒词时显示警告
- 数据包过大时提供友好的错误提示
- 实时日志输出，方便调试

#### 4. 文档整理

**新的文档结构**：
```
docs/
├── README.md                      # 文档索引
├── protocols/                     # 协议规范
│   ├── BLE分包传输协议规范.md      # ⭐ 设备端必读
│   └── ble-wifi-provisioning-spec.md
├── guides/                        # 使用指南
│   ├── WiFi配网快速开始.md
│   ├── 本地音素转换快速参考.md
│   └── ...（10个文件）
└── troubleshooting/               # 故障排查
    ├── 查看日志.md
    └── ...（6个文件）

scripts/                           # 实用脚本
├── 启动应用.sh
└── debug_device.sh
```

### 🔧 技术细节

#### 音素优化策略
为了减少数据包大小，采用了激进的优化：

| 原始 | 优化后 | 节省 |
|------|--------|------|
| 5个音素变体 | 1个音素 | ~70% |
| "HH AY1 B AH1 D IY0" | "hi buddy" | 使用最短表示 |

**优化后的数据大小**：
- 1 个唤醒词: ~140 字节 ✅
- 2 个唤醒词: ~220 字节 ✅
- 3 个唤醒词: ~300 字节 → 自动分包 📦

#### 分包传输时序

```
App                     ESP32
 │                        │
 │  包1 [0][2][240字节]   │
 ├───────────────────────>│
 │                        │ 保存到 buffer
 │    延迟 50ms           │
 │                        │
 │  包2 [1][2][60字节]    │
 ├───────────────────────>│
 │                        │ 接收完成
 │                        │ 处理完整数据
 │  {"status":"success"}  │
 │<───────────────────────┤
```

### 📋 待办事项

#### 设备端（ESP32）
- [ ] 实现分包接收逻辑
- [ ] 测试 1-5 个包的接收
- [ ] 实现超时处理（5秒）
- [ ] 验证数据完整性

**参考实现**: 见 [BLE分包传输协议规范.md](protocols/BLE分包传输协议规范.md)

#### App 端
- [x] 分包发送功能 ✅
- [x] UI 状态改进 ✅
- [x] 本地音素转换 ✅
- [ ] 扩展音素词典到 200+ 词
- [ ] 添加自定义词典导入功能

### 🧪 测试建议

#### 测试用例 1: 单个唤醒词
```
选择: 1 个唤醒词
预期: 直接发送，不分包
数据: ~140 字节
结果: 应该成功 ✅
```

#### 测试用例 2: 两个唤醒词
```
选择: 2 个唤醒词
预期: 直接发送，不分包
数据: ~220 字节
结果: 应该成功 ✅
```

#### 测试用例 3: 三个唤醒词 ⭐
```
选择: 3 个唤醒词
预期: 启用分包传输
数据: ~300 字节（分2个包）
结果: 取决于设备端是否支持分包
```

**查看日志**：
```bash
flutter logs | grep -E "\[BLE|分包"
```

**预期输出**：
```
[BLE WiFi] 发送数据长度: 300 字节
[BLE WiFi] 数据过大，启用分包传输: 300 字节
[BLE WiFi] ┌─ 分包传输开始 ─────────────
[BLE WiFi] │ 总大小: 300 字节
[BLE WiFi] │ 分包数: 2
[BLE WiFi] │ 发送分包 1/2: 240 字节
[BLE WiFi] │ 发送分包 2/2: 60 字节
[BLE WiFi] └─ 分包传输完成 ─────────────
```

### 🐛 已知问题

#### 设备端分包支持
- **状态**: 未确认
- **影响**: 3个以上唤醒词可能发送失败
- **临时方案**: 限制为 1-2 个唤醒词
- **长期方案**: 等待设备端实现分包接收

### 📞 需要支持？

1. **查看日志**: [查看日志.md](troubleshooting/查看日志.md)
2. **协议文档**: [BLE分包传输协议规范.md](protocols/BLE分包传输协议规范.md)
3. **快速开始**: [WiFi配网快速开始.md](guides/WiFi配网快速开始.md)

### 🎯 推荐配置

**当前推荐**（设备端未支持分包前）：
```dart
// 一次配置 1-2 个唤醒词
final words = [word1, word2];  // 最多2个
```

**未来配置**（设备端支持分包后）：
```dart
// 可以配置更多唤醒词
final words = [word1, word2, word3, word4, word5];  // 5-10个
```

---

**贡献者**: Flutter BLE 项目团队  
**最后更新**: 2025-11-20 23:00  
**版本**: 1.1.0

