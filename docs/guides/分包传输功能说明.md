# BLE 分包传输功能说明

## ✅ 功能已实现

您的代码中**已经实现了完整的分包传输功能**！

## 工作原理

### 1. 自动分包逻辑

```dart
// 在 _sendCommand 中
if (data.length <= 240) {
  // 直接发送
  await _characteristic!.write(data);
} else {
  // 自动启用分包传输
  await _sendChunked(data);
}
```

### 2. 分包协议格式

每个分包结构：
```
[包序号(1字节)][总包数(1字节)][数据(最多240字节)]
```

**示例**：
- 数据总大小：439 字节
- 分包数量：2 个包
  - 包1: `[0][2][...240字节数据...]`  (242字节)
  - 包2: `[1][2][...199字节数据...]`  (201字节)

### 3. 发送流程

```
439字节数据
    ↓
┌─ 分包传输开始 ─────────────
│ 总大小: 439 字节
│ 分包数: 2
│ 每包大小: 最大 240 字节
│
│ 发送分包 1/2: 240 字节 (总计: 242 字节)
│   → 等待 50ms
│ 发送分包 2/2: 199 字节 (总计: 201 字节)
└─ 分包传输完成 ─────────────
✓ 成功发送 2 个分包
```

## 📱 如何使用

### 步骤 1: 重新编译和运行应用

```bash
cd /Users/xionghao/Documents/GitHub/flutter-ble

# 停止当前应用
flutter clean

# 重新运行
flutter run
```

### 步骤 2: 测试分包传输

1. 打开应用，连接设备
2. 进入唤醒词配置页面
3. 选择 **3 个唤醒词**（会触发分包传输）
4. 点击"发送到设备"

### 预期日志输出

```
flutter: [BLE Wake] 发送设置唤醒词命令: 3个
flutter: [BLE Wake] 优化唤醒词 "hi buddy": 3 -> 1 个音素
flutter: [BLE Wake] 优化唤醒词 "hi assistant": 3 -> 1 个音素  
flutter: [BLE Wake] 优化唤醒词 "hey friend": 3 -> 1 个音素
flutter: [BLE WiFi] 发送数据长度: 260 字节
flutter: [BLE WiFi] 数据过大，启用分包传输: 260 字节
flutter: [BLE WiFi] ┌─ 分包传输开始 ─────────────
flutter: [BLE WiFi] │ 总大小: 260 字节
flutter: [BLE WiFi] │ 分包数: 2
flutter: [BLE WiFi] │ 每包大小: 最大 240 字节
flutter: [BLE WiFi] │ 发送分包 1/2: 240 字节 (总计: 242 字节)
flutter: [BLE WiFi] │ 发送分包 2/2: 20 字节 (总计: 22 字节)
flutter: [BLE WiFi] └─ 分包传输完成 ─────────────
flutter: [BLE WiFi] ✓ 成功发送 2 个分包
```

## ⚠️ 重要前提

### ESP32 设备端必须支持分包接收！

分包传输需要设备端（ESP32）实现相应的接收逻辑：

```cpp
// ESP32 端伪代码
uint8_t buffer[2000];  // 接收缓冲区
int totalChunks = 0;
int receivedChunks = 0;
int bufferPos = 0;

void onBLEWrite(uint8_t* data, size_t len) {
  if (len >= 2) {
    uint8_t chunkIndex = data[0];  // 包序号
    uint8_t chunkTotal = data[1];  // 总包数
    
    if (chunkTotal > 1) {
      // 分包接收模式
      if (chunkIndex == 0) {
        // 第一个包，初始化
        totalChunks = chunkTotal;
        receivedChunks = 0;
        bufferPos = 0;
      }
      
      // 复制数据（跳过头部2字节）
      memcpy(buffer + bufferPos, data + 2, len - 2);
      bufferPos += (len - 2);
      receivedChunks++;
      
      if (receivedChunks == totalChunks) {
        // 所有包接收完毕，处理完整数据
        processCommand(buffer, bufferPos);
      }
    } else {
      // 单包模式（兼容旧协议）
      processCommand(data, len);
    }
  }
}
```

## 🔍 验证设备端是否支持

### 方法 1: 查看设备日志

如果 ESP32 支持日志输出，查看是否有分包接收的日志。

### 方法 2: 测试发送

发送 3 个唤醒词：
- ✅ **如果成功**：设备端支持分包
- ❌ **如果失败**：设备端不支持，需要更新固件

### 方法 3: 联系硬件开发者

询问 ESP32 固件是否实现了分包接收协议。

## 📊 数据大小参考

### 优化后（每个唤醒词1个音素）

| 唤醒词数量 | 预估大小 | 传输方式 |
|-----------|---------|----------|
| 1个 | ~140字节 | 直接发送 ✅ |
| 2个 | ~220字节 | 直接发送 ✅ |
| 3个 | ~300字节 | **分包传输** 📦 |
| 4个 | ~380字节 | **分包传输** 📦 |
| 5个 | ~460字节 | **分包传输** 📦 |
| 10个 | ~900字节 | **分包传输** 📦 |

## 🚨 如果设备端不支持分包

### 临时解决方案

1. **限制为2个唤醒词**
   ```dart
   if (_selectedPresets.length > 2) {
     showError('最多支持2个唤醒词');
     return;
   }
   ```

2. **分批次发送**
   - 第一次：发送唤醒词 1-2
   - 第二次：发送唤醒词 3-4
   - 使用 `replace: false` 参数追加而非替换

3. **请求固件更新**
   - 联系硬件团队更新 ESP32 固件
   - 实现分包接收协议

## 🎯 推荐配置

### 如果设备支持分包
```dart
// 可以一次发送多个唤醒词
final words = [
  word1, word2, word3, word4, word5, // 支持 5-10 个
];
await _bleService.setWakeWords(words: words);
```

### 如果设备不支持分包
```dart
// 方式1: 限制数量
if (words.length > 2) {
  throw Exception('最多支持2个唤醒词');
}

// 方式2: 分批发送
await _bleService.setWakeWords(
  words: words.sublist(0, 2),
  replace: true,  // 第一批：替换
);

await _bleService.setWakeWords(
  words: words.sublist(2, 4),
  replace: false, // 第二批：追加
);
```

## 🧪 测试建议

### 测试用例 1: 单个唤醒词
```
预期：直接发送，不分包
结果：应该成功
```

### 测试用例 2: 两个唤醒词
```
预期：直接发送，不分包
结果：应该成功
```

### 测试用例 3: 三个唤醒词 ⭐
```
预期：启用分包传输
结果：如果设备支持则成功，否则失败
```

### 测试用例 4: 五个唤醒词
```
预期：启用分包传输（2-3个包）
结果：测试设备端分包接收的健壮性
```

## 📝 调试命令

查看实时日志：
```bash
flutter logs | grep -E "\[BLE|分包"
```

只看分包相关：
```bash
flutter logs | grep "分包"
```

## 总结

| 项目 | 状态 |
|------|------|
| App 端分包发送 | ✅ 已实现 |
| 协议定义清晰 | ✅ 是 |
| 自动触发 | ✅ 是 |
| 设备端支持 | ❓ **需要验证** |

**下一步**：
1. 重新运行应用（`flutter run`）
2. 测试发送 3 个唤醒词
3. 查看日志确认是否触发分包
4. 验证设备端是否正常接收

---

**创建时间**: 2025-11-20  
**状态**: ✅ 功能完整，待设备端验证

