# 唤醒词功能实现说明

**实现日期**: 2024-11-18  
**版本**: v1.0  
**开发者**: AI Assistant

---

## 一、功能概述

本次更新为 Flutter BLE 应用添加了完整的**蓝牙自定义唤醒词配置功能**，允许用户通过 APP 端动态配置小智设备的语音唤醒词。

### 主要特性

- ✅ 设置多个自定义唤醒词（最多10个）
- ✅ 预置17个常用唤醒词（含音素映射）
- ✅ 支持4个分类：小智专属、通用助手、友好型、科技感
- ✅ 动态调整检测阈值（0.05-0.30）
- ✅ 获取当前设备唤醒词列表
- ✅ 删除单个唤醒词
- ✅ 一键重置为默认唤醒词
- ✅ 实时状态反馈
- ✅ 复用现有 BLE 通道（0xFFE0/0xFFE1）

---

## 二、实现架构

### 2.1 文件结构

```
lib/
├── wake_word_models.dart          # 数据模型
├── wake_word_presets.dart         # 预置唤醒词词典
├── wake_word_config_page.dart     # UI配置页面
├── ble_wifi_service.dart          # BLE服务（扩展）
└── main.dart                      # 主入口（添加入口）
```

### 2.2 核心组件

#### 1. **数据模型** (`wake_word_models.dart`)

- `WakeWord`: 唤醒词实体类
  - `text`: 原始文本（如："hi plaud"）
  - `display`: 显示名称（如："Hi Plaud"）
  - `phonemes`: 音素列表（ARPABET格式）

- `WakeWordResult`: 操作结果类
  - 包含成功/失败状态、消息、错误码等
  - 提供友好的错误描述方法

- `PresetWakeWord`: 预置唤醒词配置类
  - 额外包含分类和描述信息

- `WakeWordCategory`: 唤醒词分类类

#### 2. **预置词典** (`wake_word_presets.dart`)

包含17个预置唤醒词，分为4个分类：

| 分类 | 数量 | 示例 |
|------|------|------|
| 小智专属 | 2个 | Hi Plaud, Hey Plaud |
| 通用助手 | 5个 | Hi Assistant, Hey Siri, OK Google |
| 友好型 | 4个 | Hi Buddy, Hey Friend, Hi There |
| 科技感 | 4个 | Hey Jarvis, OK Computer, Alexa |

每个唤醒词包含3-5个音素变体，以提高识别率。

**音素格式说明**：
- 使用 ARPABET 音素系统（类似 CMU 发音词典）
- 数字 0/1/2 表示重音级别
- 示例：`"HH AY1 P L AA1 D"` = "Hi Plaud"

#### 3. **BLE服务扩展** (`ble_wifi_service.dart`)

在现有 `BLEWiFiService` 中添加了唤醒词相关方法：

**新增方法**：
```dart
// 设置唤醒词
Future<bool> setWakeWords({
  required List<WakeWord> words,
  double threshold = 0.15,
  bool replace = true,
});

// 获取唤醒词列表
Future<bool> getWakeWords();

// 删除单个唤醒词
Future<bool> deleteWakeWord(String text);

// 重置为默认
Future<bool> resetWakeWords();
```

**新增回调**：
```dart
Function(WakeWordResult)? onWakeWordResult;
Function(List<WakeWord>, double)? onWakeWordsReceived;
```

**命令处理**：
- 复用现有的 JSON 命令通道
- 通过 `cmd` 字段区分不同功能
- 支持分包数据、超时处理、错误重试

#### 4. **UI配置页面** (`wake_word_config_page.dart`)

提供直观的唤醒词配置界面：

**主要功能区**：
1. **当前唤醒词卡片**: 显示设备当前配置的唤醒词
2. **检测阈值调节**: 滑块控制（0.05-0.30）
3. **分类标签**: 快速切换4个分类
4. **唤醒词列表**: 可选择的预置唤醒词
5. **底部操作栏**: 显示选择数量，发送到设备

**交互特性**：
- 实时选择/取消选择
- 最多选择10个唤醒词限制
- 自动加载设备当前配置
- 实时状态反馈（加载中、发送中、成功、失败）

---

## 三、蓝牙通信协议

### 3.1 Service 和 Characteristic

| 项目 | UUID |
|------|------|
| Service UUID | `0000FFE0-0000-1000-8000-00805F9B34FB` |
| Characteristic UUID | `0000FFE1-0000-1000-8000-00805F9B34FB` |
| 权限 | READ + WRITE + NOTIFY |

**注意**：与 WiFi 配网功能复用相同通道，通过 JSON 的 `cmd` 字段区分功能。

### 3.2 命令格式

#### 设置唤醒词 (`set_wake_words`)

**请求**：
```json
{
  "cmd": "set_wake_words",
  "data": {
    "words": [
      {
        "text": "hi plaud",
        "display": "Hi Plaud",
        "phonemes": ["hi PLAA1D", "hi PLaD", "HH AY1 P L AA1 D"]
      }
    ],
    "threshold": 0.15,
    "replace": true
  }
}
```

**响应**：
```json
{
  "cmd": "set_wake_words",
  "status": "success",
  "data": {
    "message": "唤醒词配置成功",
    "count": 1
  }
}
```

#### 获取唤醒词 (`get_wake_words`)

**请求**：
```json
{
  "cmd": "get_wake_words"
}
```

**响应**：
```json
{
  "cmd": "get_wake_words",
  "status": "success",
  "data": {
    "words": [
      {
        "text": "hi plaud",
        "display": "Hi Plaud",
        "phonemes": ["hi PLAA1D", "hi PLaD"]
      }
    ],
    "threshold": 0.15,
    "count": 1
  }
}
```

#### 删除唤醒词 (`delete_wake_word`)

**请求**：
```json
{
  "cmd": "delete_wake_word",
  "data": {
    "text": "hi plaud"
  }
}
```

**响应**：
```json
{
  "cmd": "delete_wake_word",
  "status": "success",
  "data": {
    "message": "唤醒词删除成功"
  }
}
```

#### 重置唤醒词 (`reset_wake_words`)

**请求**：
```json
{
  "cmd": "reset_wake_words"
}
```

**响应**：
```json
{
  "cmd": "reset_wake_words",
  "status": "success",
  "data": {
    "message": "已恢复默认唤醒词",
    "count": 2
  }
}
```

### 3.3 错误码

| 错误码 | 说明 | 用户友好提示 |
|-------|------|-------------|
| -1 | JSON 解析失败 | JSON 解析失败，请重试 |
| -2 | 音素列表为空 | 音素列表为空，请检查唤醒词配置 |
| -3 | 设备存储失败 | 设备存储失败，请重启设备后重试 |
| -4 | 唤醒词数量超限 | 唤醒词数量超过限制（最多10个） |
| -5 | 音素格式错误 | 音素格式错误，请使用预置唤醒词 |

---

## 四、使用流程

### 4.1 用户操作流程

1. **连接设备**
   - 在设备列表页扫描并连接 PLAUD 设备

2. **进入唤醒词配置**
   - 在设备详情页点击"唤醒词配置"卡片

3. **查看当前配置**
   - 页面自动加载设备当前的唤醒词配置

4. **选择唤醒词**
   - 切换分类标签浏览不同类型的唤醒词
   - 点击唤醒词卡片进行选择/取消选择
   - 最多选择10个唤醒词

5. **调整阈值**（可选）
   - 滑动阈值滑块（推荐：0.10-0.20）
   - 阈值越小越灵敏，但可能误触发

6. **发送到设备**
   - 点击底部"发送到设备"按钮
   - 等待发送完成
   - 查看成功/失败提示

7. **测试唤醒**
   - 配置成功后，对设备说出唤醒词测试

### 4.2 开发者集成流程

如果需要在其他页面调用唤醒词功能：

```dart
// 1. 导入依赖
import 'package:flutter_blue_plus/flutter_blue_plus.dart';
import 'ble_wifi_service.dart';
import 'wake_word_models.dart';
import 'wake_word_presets.dart';

// 2. 初始化服务
final bleService = BLEWiFiService(device);
await bleService.initialize();

// 3. 设置回调
bleService.onWakeWordResult = (result) {
  if (result.success) {
    print('设置成功: ${result.message}');
  } else {
    print('设置失败: ${result.getErrorDescription()}');
  }
};

bleService.onWakeWordsReceived = (words, threshold) {
  print('收到 ${words.length} 个唤醒词');
};

// 4. 发送命令
final words = [
  presetWakeWords['hi plaud']!.toWakeWord(),
  presetWakeWords['hey assistant']!.toWakeWord(),
];

await bleService.setWakeWords(
  words: words,
  threshold: 0.15,
  replace: true,
);

// 5. 释放资源
await bleService.dispose();
```

---

## 五、设备端要求

### 5.1 必须实现的功能

设备端（ESP32）需要实现以下命令处理：

1. ✅ `set_wake_words`: 设置唤醒词
2. ✅ `get_wake_words`: 获取唤醒词列表
3. ✅ `delete_wake_word`: 删除单个唤醒词
4. ✅ `reset_wake_words`: 重置为默认唤醒词

### 5.2 数据格式要求

- JSON 格式，UTF-8 编码
- 以 `\n` 结尾（便于分包拼接）
- 单个消息建议 < 512 字节
- 支持标准 JSON 解析库

### 5.3 存储要求

- 使用 NVS（非易失性存储）保存配置
- 支持最多10个唤醒词
- 重启后配置保留

### 5.4 音素识别要求

- 使用 ESP-SR 的 MultiNet 模型
- 支持 ARPABET 音素格式
- 支持动态添加/删除唤醒词
- 支持阈值动态调整（0.0-1.0）

---

## 六、测试建议

### 6.1 功能测试

- [ ] 连接设备成功
- [ ] 加载当前唤醒词成功
- [ ] 选择单个唤醒词并发送
- [ ] 选择多个唤醒词并发送
- [ ] 选择10个唤醒词（边界测试）
- [ ] 调整阈值并发送
- [ ] 删除唤醒词功能
- [ ] 重置为默认功能
- [ ] 断开连接时的错误提示

### 6.2 边界测试

- [ ] 选择0个唤醒词时禁用发送按钮
- [ ] 选择超过10个时显示提示
- [ ] 设备未连接时的错误处理
- [ ] BLE 服务初始化失败的处理
- [ ] 超时场景的处理
- [ ] 网络中断的处理

### 6.3 用户体验测试

- [ ] 加载状态显示清晰
- [ ] 发送状态实时反馈
- [ ] 成功/失败提示友好
- [ ] 页面切换流畅
- [ ] 选择交互直观
- [ ] 阈值滑块易用

---

## 七、已知限制

1. **音素格式**
   - 当前仅支持英文唤醒词（ARPABET 音素）
   - 中文支持需要切换 MultiNet 模型

2. **唤醒词数量**
   - 最多支持10个唤醒词
   - 过多会影响识别准确率

3. **自定义音素**
   - 暂不支持用户自定义音素
   - 只能从预置词典中选择
   - 高级功能可添加在线音素转换 API

4. **离线限制**
   - 音素转换完全离线
   - 无法处理预置词典外的唤醒词

---

## 八、未来扩展方向

### 8.1 短期优化

- [ ] 添加搜索功能（搜索唤醒词）
- [ ] 支持自定义唤醒词文本
- [ ] 集成在线音素转换 API
- [ ] 添加唤醒词测试功能（录音测试）
- [ ] 支持导入/导出配置

### 8.2 中期功能

- [ ] 支持中文唤醒词
- [ ] 语音合成预览
- [ ] 唤醒词识别率统计
- [ ] 云端同步配置
- [ ] 多设备配置管理

### 8.3 长期愿景

- [ ] AI 自动生成最佳音素
- [ ] 个性化语音训练
- [ ] 多语言混合唤醒词
- [ ] 语境感知唤醒
- [ ] 声纹识别集成

---

## 九、参考资料

- [唤醒词动态配置 API 文档](../docs/xiaozhi-esp32/wakeup/wake-word-config-api.md)
- [CMU Pronouncing Dictionary](http://www.speech.cs.cmu.edu/cgi-bin/cmudict)
- [ARPABET 音素系统](https://en.wikipedia.org/wiki/ARPABET)
- [ESP-SR 文档](https://github.com/espressif/esp-sr)

---

## 十、更新日志

### v1.0 (2024-11-18)

- ✅ 初始版本发布
- ✅ 实现设置/获取/删除/重置唤醒词功能
- ✅ 内置17个预置唤醒词
- ✅ 支持4个分类
- ✅ 完整的 UI 交互界面
- ✅ 错误处理和状态反馈
- ✅ 复用现有 BLE 通道

---

## 联系方式

如有问题，请联系：
- 项目仓库：https://github.com/78/xiaozhi-esp32
- QQ 群：1011329060

---

**祝使用愉快！** 🎉


